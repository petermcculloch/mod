{
	"patcher" : 	{
		"fileversion" : 1,
		"appversion" : 		{
			"major" : 7,
			"minor" : 2,
			"revision" : 3,
			"architecture" : "x86",
			"modernui" : 1
		}
,
		"rect" : [ 355.0, 78.0, 765.0, 645.0 ],
		"editing_bgcolor" : [ 0.9, 0.9, 0.9, 1.0 ],
		"bglocked" : 0,
		"openinpresentation" : 0,
		"default_fontsize" : 12.0,
		"default_fontface" : 0,
		"default_fontname" : "Arial",
		"gridonopen" : 1,
		"gridsize" : [ 15.0, 15.0 ],
		"gridsnaponopen" : 1,
		"objectsnaponopen" : 1,
		"statusbarvisible" : 2,
		"toolbarvisible" : 1,
		"lefttoolbarpinned" : 0,
		"toptoolbarpinned" : 0,
		"righttoolbarpinned" : 0,
		"bottomtoolbarpinned" : 0,
		"toolbars_unpinned_last_save" : 0,
		"tallnewobj" : 0,
		"boxanimatetime" : 200,
		"enablehscroll" : 1,
		"enablevscroll" : 1,
		"devicewidth" : 0.0,
		"description" : "",
		"digest" : "",
		"tags" : "",
		"style" : "",
		"subpatcher_template" : "",
		"boxes" : [ 			{
				"box" : 				{
					"id" : "obj-6",
					"maxclass" : "newobj",
					"numinlets" : 1,
					"numoutlets" : 0,
					"patching_rect" : [ 694.0, 543.0, 37.0, 22.0 ],
					"style" : "",
					"text" : "out 3"
				}

			}
, 			{
				"box" : 				{
					"id" : "obj-3",
					"maxclass" : "newobj",
					"numinlets" : 0,
					"numoutlets" : 2,
					"outlettype" : [ "", "" ],
					"patching_rect" : [ 219.666656, 543.0, 108.0, 22.0 ],
					"style" : "",
					"text" : "buffer weights 256"
				}

			}
, 			{
				"box" : 				{
					"id" : "obj-12",
					"maxclass" : "newobj",
					"numinlets" : 1,
					"numoutlets" : 1,
					"outlettype" : [ "" ],
					"patching_rect" : [ 468.333344, 47.0, 23.0, 22.0 ],
					"style" : "",
					"text" : "int"
				}

			}
, 			{
				"box" : 				{
					"id" : "obj-11",
					"maxclass" : "newobj",
					"numinlets" : 0,
					"numoutlets" : 1,
					"outlettype" : [ "" ],
					"patching_rect" : [ 468.333344, 12.0, 198.0, 22.0 ],
					"style" : "",
					"text" : "in 3 @min 1 @max 256 @default 8"
				}

			}
, 			{
				"box" : 				{
					"id" : "obj-16",
					"maxclass" : "newobj",
					"numinlets" : 0,
					"numoutlets" : 1,
					"outlettype" : [ "" ],
					"patching_rect" : [ 694.0, 12.0, 30.0, 22.0 ],
					"style" : "",
					"text" : "in 4"
				}

			}
, 			{
				"box" : 				{
					"id" : "obj-27",
					"maxclass" : "newobj",
					"numinlets" : 1,
					"numoutlets" : 0,
					"patching_rect" : [ 355.5, 543.0, 37.0, 22.0 ],
					"style" : "",
					"text" : "out 2"
				}

			}
, 			{
				"box" : 				{
					"id" : "obj-15",
					"maxclass" : "newobj",
					"numinlets" : 0,
					"numoutlets" : 2,
					"outlettype" : [ "", "" ],
					"patching_rect" : [ 82.0, 543.0, 114.0, 22.0 ],
					"style" : "",
					"text" : "buffer registers 256"
				}

			}
, 			{
				"box" : 				{
					"code" : "History sum(0);\r\nHistory power_of_two(1);\r\nHistory bit_sum(0);\r\nHistory flip(0);\r\nParam bits(8,min=1,max=31);\r\nParam msb(0);\r\nParam normalize(1,min=0,max=1);\r\nParam normalize_bits(0);\r\nParam rising(1,default=1); // Trigger only on rising edge by default\r\nHistory norm_two(255);\r\nHistory norm_weights(1.);\r\nHistory norm_weights_offset(0.);\r\nHistory test_val(0);\r\n\r\ntrig = rising ? delta(in1 > 0) > 0 : in1 > 0;\r\n\r\nif (trig) {\r\n\tlength = in3;\r\n\tpower_of_two = 1;\r\n\tnext = 0;\r\n\tbit_sum = 0;\r\n\tsum = 0;\r\n\t\r\n\trev = in2 > 0;\r\n\tinc = rev ? 1 : -1;\r\n\tflip = (0.5*(noise()+1) < in4);\r\n\t\t\r\n\tj = rev ? 0 : length-1;\r\n\t// Going forward: (7 -> 0), 6 -> 7, 5 -> 6, 4 -> 5, 3 -> 4, 2 -> 3, 1-> 2, 0 -> 1\r\n\t//     Backwards: (0 -> 7), 1 -> 0, 2 -> 1, 3 -> 2, 4 -> 3, 5 -> 4, 6 -> 5, 7 -> 6\r\n\tlast_j = wrap(j - inc,0,length);\r\n\tlast_val = xor(flip,peek(registers,j));\r\n\r\n\t// TODO rotate the read pointer, not the buffer.\r\n\tfor (i=0; i<length-1; i+=1) {\r\n\t\tval = peek(registers,wrap(j+inc,0,length));\r\n\t\tpoke(registers,val,j);\r\n\t\tj = wrap(j+inc,0,length);\r\n\t}\r\n\t\r\n\tpoke(registers,last_val,last_j);\r\n\r\n\t\r\n\tnorm_weights = 0.;\r\n\tnorm_weights_offset = 0.;\r\n\t\r\n\t\r\n\r\n\tif (msb) {\r\n\t\tpower_of_two = pow(2,bits-1);\r\n\t\ti_max = min(bits,length);\r\n\t\tfor (i=0; i<i_max; i+=1) {\r\n\t\t\ta = peek(registers,i);\r\n\t\t\tb = peek(weights,i_max - i);\r\n\t\t\tsum += (a*b);\r\n\t\t\tbit_sum += a*power_of_two;\r\n\t\t\tpower_of_two *= 0.5;\r\n\t\t\tnorm_weights += abs(b);\r\n\t\t\tnorm_weights_offset = min(norm_weights_offset,b);\r\n\t\t}\r\n\t} else {\r\n\t\tfor (i=0; i<min(bits,length); i+=1) {\r\n\t\t\ta = peek(registers,i);\r\n\t\t\tb = peek(weights,i);\r\n\r\n\t\t\tsum += (a*b);\r\n\t\t\tbit_sum += a*power_of_two;\r\n\t\t\tpower_of_two += power_of_two;\r\n\t\t\tnorm_weights += abs(b);\r\n\t\t\tnorm_weights_offset = min(norm_weights_offset,b);\r\n\t\t}\r\n\t\t\r\n\t}\r\n\tnorm_two = power_of_two;\r\n\tnorm_weights += (norm_weights == 0.);\t\r\n}\r\n\r\nout1 = normalize ? (sum - norm_weights_offset) / (norm_weights - norm_weights_offset) : sum;\r\nout2 = normalize_bits ? bit_sum / norm_two : bit_sum;\r\nout3 = flip;\r\n",
					"fontface" : 0,
					"fontname" : "Arial",
					"fontsize" : 12.0,
					"id" : "obj-5",
					"maxclass" : "codebox",
					"numinlets" : 4,
					"numoutlets" : 3,
					"outlettype" : [ "", "", "" ],
					"patching_rect" : [ 17.0, 82.0, 696.0, 447.0 ],
					"style" : ""
				}

			}
, 			{
				"box" : 				{
					"id" : "obj-1",
					"maxclass" : "newobj",
					"numinlets" : 0,
					"numoutlets" : 1,
					"outlettype" : [ "" ],
					"patching_rect" : [ 17.0, 12.0, 30.0, 22.0 ],
					"style" : "",
					"text" : "in 1"
				}

			}
, 			{
				"box" : 				{
					"id" : "obj-2",
					"maxclass" : "newobj",
					"numinlets" : 0,
					"numoutlets" : 1,
					"outlettype" : [ "" ],
					"patching_rect" : [ 242.666656, 12.0, 30.0, 22.0 ],
					"style" : "",
					"text" : "in 2"
				}

			}
, 			{
				"box" : 				{
					"id" : "obj-4",
					"maxclass" : "newobj",
					"numinlets" : 1,
					"numoutlets" : 0,
					"patching_rect" : [ 17.0, 543.0, 37.0, 22.0 ],
					"style" : "",
					"text" : "out 1"
				}

			}
 ],
		"lines" : [ 			{
				"patchline" : 				{
					"destination" : [ "obj-5", 0 ],
					"disabled" : 0,
					"hidden" : 0,
					"source" : [ "obj-1", 0 ]
				}

			}
, 			{
				"patchline" : 				{
					"destination" : [ "obj-12", 0 ],
					"disabled" : 0,
					"hidden" : 0,
					"source" : [ "obj-11", 0 ]
				}

			}
, 			{
				"patchline" : 				{
					"destination" : [ "obj-5", 2 ],
					"disabled" : 0,
					"hidden" : 0,
					"source" : [ "obj-12", 0 ]
				}

			}
, 			{
				"patchline" : 				{
					"destination" : [ "obj-5", 3 ],
					"disabled" : 0,
					"hidden" : 0,
					"source" : [ "obj-16", 0 ]
				}

			}
, 			{
				"patchline" : 				{
					"destination" : [ "obj-5", 1 ],
					"disabled" : 0,
					"hidden" : 0,
					"source" : [ "obj-2", 0 ]
				}

			}
, 			{
				"patchline" : 				{
					"destination" : [ "obj-27", 0 ],
					"disabled" : 0,
					"hidden" : 0,
					"source" : [ "obj-5", 1 ]
				}

			}
, 			{
				"patchline" : 				{
					"destination" : [ "obj-4", 0 ],
					"disabled" : 0,
					"hidden" : 0,
					"source" : [ "obj-5", 0 ]
				}

			}
, 			{
				"patchline" : 				{
					"destination" : [ "obj-6", 0 ],
					"disabled" : 0,
					"hidden" : 0,
					"source" : [ "obj-5", 2 ]
				}

			}
 ],
		"autosave" : 0
	}

}
